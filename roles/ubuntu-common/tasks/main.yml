---
# This playbook cleans up all miners and removes all services

- name: sudo
  become: yes
  template:
    src: "90-wes.sudo"
    dest: "/etc/sudoers.d/90-wes"

- name: Add authorized key
  authorized_key:
    user: wes
    state: present
    key: '{{ item }}'
  with_file: 
    - public-keys/wes

- name: Add apt key
  become: yes
  apt_key:
    data: "{{ lookup('file', 'public-keys/D3F1E2F6-public.key') }}"
    state: present

- name: Setup apt repositories
  become: yes
  apt_repository:
    repo: "{{ item }}"
    state: present
  with_items:
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }} main restricted"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-updates main restricted"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }} universe"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-updates universe"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }} multiverse"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-updates multiverse"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-archive-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-backports main restricted universe multiverse"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-security-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-security main restricted"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-security-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-security universe"
     - "deb https://nexus.cowtownt.org/repository/ubuntu-security-{{ ansible_distribution_release }}/ {{ ansible_distribution_release }}-security multiverse"
#     - "deb https://nexus.cowtownt.org/repository/ubuntu-{{ ansible_distribution_release }}-custom/ {{ ansible_distribution_release }} main restricted"

- name: Delete internet apt repositories
  become: yes
  apt_repository:
    repo: "{{ item }}"
    state: absent
  with_items:
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }} main restricted"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-updates main restricted"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }} universe"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-updates universe"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }} multiverse"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-updates multiverse"
    - "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-backports main restricted universe multiverse"
    - "deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security main restricted"
    - "deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security universe"
    - "deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security multiverse"

- name: Set kernel.panic in sysctl.conf
  become: yes
  lineinfile:
    path: /etc/sysctl.conf
    regexp: '^kernel.panic ='
    line: 'kernel.panic = 10'
  register: sysctl

- name: Reload sysctl settings
  become: yes
  command: sysctl -p
  when: sysctl.changed
  
